#!/bin/bash

# Global post-commit hook for automated code reviews using ClaudeReview
# This hook is triggered after every git commit in any repository

# Get repository path and latest commit hash
REPO_PATH=$(git rev-parse --show-toplevel 2>/dev/null)
COMMIT_HASH=$(git rev-parse HEAD 2>/dev/null)

# Verify we're in a git repository
if [ -z "$REPO_PATH" ] || [ -z "$COMMIT_HASH" ]; then
    exit 0
fi

# Path to ClaudeReview directory
# Automatically searches common locations
if [ -d "$HOME/.claude-review" ]; then
    CLAUDE_REVIEW_DIR="$HOME/.claude-review"
elif [ -d "$HOME/ClaudeReview" ]; then
    CLAUDE_REVIEW_DIR="$HOME/ClaudeReview"
elif [ -n "$CLAUDE_REVIEW_PATH" ]; then
    CLAUDE_REVIEW_DIR="$CLAUDE_REVIEW_PATH"
else
    # Fallback: look for node_modules/@claude-review (if installed globally)
    CLAUDE_REVIEW_DIR=""
fi

# Check if ClaudeReview exists
if [ -z "$CLAUDE_REVIEW_DIR" ] || [ ! -d "$CLAUDE_REVIEW_DIR" ]; then
    # Silently exit if not found (don't spam user with warnings)
    exit 0
fi

# Load environment variables
if [ -f "$CLAUDE_REVIEW_DIR/.env" ]; then
    export $(cat "$CLAUDE_REVIEW_DIR/.env" | grep -v '^#' | xargs)
fi

# Run review in background to avoid blocking the commit
(
    cd "$CLAUDE_REVIEW_DIR"
    node src/index.js "$REPO_PATH" "$COMMIT_HASH" > /dev/null 2>&1
) &

# Exit successfully so commit completes
exit 0
